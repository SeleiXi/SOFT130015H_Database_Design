# 用户认证功能说明

## 功能概述

本系统新增了完整的用户认证功能，支持用户注册、登录、权限管理等功能，区分管理员和普通用户角色。

## 用户角色权限

### 管理员 (admin)
- ✅ 所有数据库管理功能
- ✅ 数据爬取功能  
- ✅ LLM评估功能
- ✅ 数据导入导出功能
- ✅ 用户管理功能
- ✅ 系统配置管理

### 评估员 (evaluator)
- ✅ 数据库查看功能
- ✅ LLM评估功能
- ✅ 数据导入功能
- ❌ 用户管理功能
- ❌ 数据爬取功能

### 访客 (guest)
- ✅ 基础数据库查看功能
- ❌ 数据修改功能
- ❌ LLM评估功能
- ❌ 用户管理功能

## 首次使用设置

### 1. 安装依赖
```bash
pip install bcrypt PyJWT streamlit-authenticator
```

### 2. 数据库初始化
系统会自动创建用户表，包含以下字段：
- `user_id`: 用户ID
- `username`: 用户名（唯一）
- `name`: 真实姓名
- `email`: 邮箱（唯一）
- `password_hash`: 加密密码
- `role`: 用户角色
- `created_at`: 创建时间
- `last_login`: 最后登录时间
- `is_active`: 是否激活

### 3. 创建管理员账户
首次使用时，点击"管理员设置"按钮创建默认管理员：
- 用户名: `admin`
- 邮箱: `admin@example.com`
- 密码: `admin123`

⚠️ **重要**: 创建后请立即登录并修改默认密码！

## 使用流程

### 用户注册
1. 访问系统主页
2. 点击"注册"按钮
3. 填写用户信息：
   - 用户名（至少3位）
   - 姓名
   - 邮箱
   - 密码（至少8位，包含字母和数字）
   - 选择用户类型（访客/评估员）
4. 提交注册

### 用户登录
1. 在登录页面输入用户名或邮箱
2. 输入密码
3. 点击"登录"按钮

### 密码修改
1. 登录后点击侧边栏"个人资料"
2. 在"修改密码"区域输入：
   - 当前密码
   - 新密码
   - 确认新密码
3. 点击"修改密码"

### 用户管理（仅管理员）
1. 登录管理员账户
2. 侧边栏选择"用户管理"
3. 查看用户统计信息
4. 管理用户列表（查看、启用/禁用）

## 安全特性

### 密码安全
- 使用 bcrypt 进行密码哈希
- 密码强度验证（最少8位，包含字母和数字）
- 支持密码修改功能

### 会话管理
- 使用 JWT 令牌进行身份验证
- 令牌有效期24小时
- 支持自动登出功能

### 权限控制
- 基于角色的访问控制（RBAC）
- 页面级权限检查
- 功能级权限验证

## 配置说明

### 环境变量配置
复制 `env-example` 文件为 `.env` 并修改配置：

```bash
# JWT配置
JWT_SECRET=your-super-secret-jwt-key-here-change-in-production
JWT_ALGORITHM=HS256
JWT_EXPIRATION_HOURS=24
```

### 自定义配置
在 `src/auth.py` 中可以修改：
- JWT 密钥和过期时间
- 密码强度要求
- 用户角色权限配置

## 常见问题

### Q: 忘记管理员密码怎么办？
A: 可以通过数据库直接重置：
```sql
-- 重置admin用户密码为admin123
UPDATE User SET password_hash = '$2b$12$...' WHERE username = 'admin';
```

### Q: 如何添加新的用户角色？
A: 在 `src/auth.py` 的 `check_permission` 方法中添加新角色和权限配置。

### Q: 用户注册后无法登录？
A: 检查用户状态是否为激活状态：
```sql
SELECT username, is_active FROM User WHERE username = 'your_username';
```

### Q: 如何批量导入用户？
A: 可以通过SQL脚本批量插入用户数据，注意密码需要先进行bcrypt加密。

## 开发说明

### 文件结构
```
src/
├── auth.py              # 认证核心模块
├── components/
│   └── auth_ui.py       # 认证界面组件
├── app.py               # 主应用（已集成认证）
└── database.py          # 数据库操作（已添加用户管理）
```

### 扩展功能
- 邮箱验证
- 双因子认证
- 密码找回
- 用户活动日志
- 更细粒度的权限控制

## 注意事项

1. **生产环境部署**：
   - 修改默认JWT密钥
   - 使用HTTPS协议
   - 定期备份用户数据

2. **密码策略**：
   - 建议定期更换密码
   - 避免使用弱密码
   - 不要共享账户

3. **权限管理**：
   - 定期审查用户权限
   - 及时禁用离职用户账户
   - 监控管理员操作

## 技术支持

如有问题请联系系统管理员或查看系统日志文件。 