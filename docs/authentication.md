# LLM问答评估系统 - 用户认证文档

## 概述

本系统新增了用户认证功能，支持用户注册、登录，并区分管理员和普通用户权限。

## 用户角色

### 管理员 (admin)
- 拥有所有功能的访问权限
- 可以管理用户账户（查看、启用/禁用、修改角色）
- 可以执行数据库管理操作（创建表、查看表结构）
- 可以执行数据导入操作
- 可以使用所有查询和分析功能

### 普通用户 (user)
- 可以查看数据库表数据（只读）
- 可以使用查询和分析功能
- 可以使用LLM评估功能
- 可以查看数据爬取功能（界面展示）
- 无法执行数据库管理和数据导入操作

## 首次使用

### 1. 系统初始化
首次运行系统时，会自动：
- 创建User表
- 显示登录界面

### 2. 创建管理员账户
在登录界面点击"创建默认管理员账户"按钮，系统会创建：
- 用户名：`admin`
- 密码：`admin123`
- 角色：管理员

**重要提醒**：请在生产环境中及时修改默认管理员密码！

### 3. 普通用户注册
- 点击"注册新用户"按钮
- 填写用户名、姓名、密码
- 默认注册为普通用户
- 如需管理员权限，请联系系统管理员

## 功能说明

### 登录功能
- 支持用户名和密码登录
- 密码使用SHA256哈希加密存储
- 登录成功后记录最后登录时间

### 注册功能
- 用户名必须唯一
- 密码最少6位字符
- 需要确认密码
- 支持真实姓名记录

### 密码管理
- 用户可以在个人中心修改密码
- 需要验证旧密码
- 新密码需要确认

### 用户管理（管理员功能）
- 查看所有用户列表
- 启用/禁用用户账户
- 修改用户角色
- 支持分页浏览

## 权限控制

### 数据库管理
- **表操作**：仅管理员可访问
- **数据查看**：所有登录用户可访问

### 数据导入
- **文件导入**：仅管理员可执行
- **导入历史**：仅管理员可查看

### LLM评估
- 所有登录用户可使用

### 查询分析
- 所有登录用户可使用

## 安全特性

### 密码安全
- 使用SHA256哈希算法
- 密码不以明文存储
- 支持密码强度验证

### 会话管理
- 基于Streamlit session_state
- 用户状态在浏览器会话中保持
- 支持安全登出

### 权限验证
- 每个敏感操作都有权限检查
- 防止越权访问
- 清晰的权限提示信息

## 数据库结构

### User表结构
```sql
CREATE TABLE User (
    user_id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(100) NOT NULL,
    password_hash VARCHAR(64) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'user' CHECK (role IN ('admin', 'user')),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP NULL,
    UNIQUE KEY unique_username (username)
);
```

### 字段说明
- `user_id`: 用户唯一标识
- `username`: 登录用户名（唯一）
- `name`: 用户真实姓名
- `password_hash`: 密码哈希值
- `role`: 用户角色（admin/user）
- `is_active`: 账户是否活跃
- `created_at`: 创建时间
- `last_login`: 最后登录时间

## 使用流程

### 管理员首次设置
1. 启动系统
2. 在登录页面点击"创建默认管理员账户"
3. 使用默认账户登录（admin/admin123）
4. 修改默认密码
5. 根据需要创建其他用户

### 普通用户使用
1. 在登录页面点击"注册新用户"
2. 填写注册信息
3. 返回登录页面登录
4. 使用系统功能

### 用户管理操作
1. 管理员登录后，点击侧边栏"用户管理"
2. 查看用户列表
3. 根据需要修改用户状态或角色
4. 管理用户权限

## 故障排除

### 常见问题

**Q: 忘记管理员密码怎么办？**
A: 可以直接在数据库中重置password_hash字段，或删除管理员记录后重新创建。

**Q: 普通用户无法访问某些功能？**
A: 检查用户角色，某些功能需要管理员权限。

**Q: 用户登录失败？**
A: 检查用户名是否正确，账户是否被禁用。

**Q: 系统提示权限不足？**
A: 联系管理员检查用户角色设置。

### 调试信息
- 认证相关错误会在界面显示具体信息
- 数据库连接问题会有相应提示
- 权限检查失败会显示权限要求

## 开发说明

### 核心文件
- `src/auth.py`: 认证核心逻辑
- `src/components/auth_ui.py`: 认证界面组件
- `src/app.py`: 主应用集成

### 扩展开发
- 支持添加更多用户角色
- 可以扩展权限粒度
- 支持集成第三方认证系统

### API接口
所有认证函数都返回统一的格式：
```python
(success: bool, result: Union[str, Dict])
```

便于错误处理和状态检查。 